<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FedEx Leave System - Admin</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --fedex-purple: #4D148C;
  --fedex-orange: #FF6600;
  --bg-gray: #f4f4f6;
}
body { margin:0; font-family:Arial,sans-serif; background:var(--bg-gray); display:flex; flex-direction:column; min-height:100vh; }
header,footer { background:var(--fedex-purple); color:white; padding:15px 20px; font-size:1.2em; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
header button { background:var(--fedex-orange); color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:bold; }
main { flex:1; padding:20px; }
h2 { color:var(--fedex-purple); text-align:center; }
.card { background:white; padding:25px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.1); overflow-x:auto; }
button.approve { background:green;color:white;padding:5px 8px;border-radius:4px;border:none;margin:2px;cursor:pointer; }
button.pend { background:orange;color:white;padding:5px 8px;border-radius:4px;border:none;margin:2px; cursor:pointer; }
button.reject { background:red;color:white;padding:5px 8px;border-radius:4px;border:none;margin:2px; cursor:pointer; }
.status-Pending{ color:orange; font-weight:bold; }
.status-Approved{ color:green; font-weight:bold; }
.status-Rejected{ color:red; font-weight:bold; }
.controls{ text-align:center; margin-bottom:15px; }
.controls button, .controls select{ padding:6px 10px; margin:4px; border-radius:4px; border:1px solid #ccc; cursor:pointer; }

/* Table */
#table { width:100%; border-collapse:collapse; margin-top:10px; }
#table th,#table td { border:1px solid #ddd; padding:8px; text-align:left; }
#table th { background:var(--fedex-purple); color:white; }
#table tr:nth-child(even){ background:#f9f9f9; }

/* Calendar Month */
.calendar-wrapper { display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:10px; }
.calendar { display:grid; grid-template-columns: repeat(7,1fr); gap:2px; }
.cal-header { font-weight:bold; background:var(--fedex-purple); color:white; padding:6px 0; border-radius:4px; }
.cal-cell { background:white; border:1px solid #ddd; min-height:80px; display:flex; flex-direction:column; align-items:flex-start; padding:4px; position:relative; border-radius:4px; font-size:12px; overflow:hidden; }
.cal-cell:hover { background:#f0f0f0; cursor:pointer; }
.cal-day { font-weight:bold; margin-bottom:2px; }
.indicator { display:block; padding:1px 3px; margin:1px 0; border-radius:3px; color:white; font-size:10px; font-weight:bold; overflow:hidden; text-overflow:ellipsis; }

/* Table indicator */
.table-indicator { display:inline-block; width:22px; height:22px; border-radius:50%; color:white; font-weight:bold; text-align:center; line-height:22px; margin:2px; font-size:12px; }
.A{background:green;} .P{background:orange;} .R{background:red;}

/* Year view mini calendars */
.year-view { display:grid; grid-template-columns:repeat(3,1fr); gap:15px; }
.year-month { border:1px solid #ccc; border-radius:8px; padding:5px; background:#fff; cursor:pointer; display:flex; flex-direction:column; transition:transform 0.2s; }
.year-month:hover{transform:scale(1.02); box-shadow:0 4px 8px rgba(0,0,0,0.2);}
.year-month-label{ text-align:center; font-weight:bold; margin-bottom:4px; }
.mini-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; font-size:8px; }
.mini-grid .day-cell { height:20px; width:20px; border-radius:4px; text-align:center; line-height:20px; position:relative; border:1px solid #eee; font-size:8px; }
.mini-grid .day-dots { position:absolute; bottom:1px; left:50%; transform:translateX(-50%); display:flex; gap:1px; }
.dot { width:4px; height:4px; border-radius:50%; }
.dot.approved{background:green;} .dot.pending{background:orange;} .dot.rejected{background:red;}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<header>
  <span id="welcomeMsg">Welcome to Admin Page</span>
  <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
</header>

<main>
<div class="controls">
  <button onclick="setFilter('All')">All</button>
  <button onclick="setFilter('Approved')">Approved</button>
  <button onclick="setFilter('Pending')">Pending</button>
  <button onclick="setFilter('Rejected')">Rejected</button>

  <select id="viewSelect" onchange="setView(this.value)">
    <option value="list">List View</option>
    <option value="table">Table View</option>
    <option value="calendar">Calendar View</option>
  </select>
</div>

  <!-- Month selector for Table view -->
  <select id="monthSelect" onchange="render()" style="display:none;">
    <option value="0">January</option>
    <option value="1">February</option>
    <option value="2">March</option>
    <option value="3">April</option>
    <option value="4">May</option>
    <option value="5">June</option>
    <option value="6">July</option>
    <option value="7">August</option>
    <option value="8">September</option>
    <option value="9">October</option>
    <option value="10">November</option>
    <option value="11">December</option>
  </select>
</div>

<div class="calendar-wrapper" id="calendarControls">
  <button onclick="changeCalendarMonth(-1)">◀</button>
  <span id="calendarMonthLabel"></span>
  <button onclick="changeCalendarMonth(1)">▶</button>
  <button onclick="setCalendarMode('month')">Month</button>
  <button onclick="setCalendarMode('year')">Year</button>
</div>

<div class="card">
  <h2>Leave Requests</h2>
  <div id="calendarContainer"><div class="calendar" id="calendarGrid"></div></div>
  <table id="table"></table>
</div>
</main>

<footer>© FedEx 2026</footer>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyAFedbBDXSZomKX8MQkBfVBRfi6tl0LTcc",
  authDomain:"fedex-attendance-system.firebaseapp.com",
  projectId:"fedex-attendance-system"
});
const db=firebase.firestore();

const currentUser=JSON.parse(localStorage.getItem("currentUser"));
if(!currentUser){ alert("Please login first"); location.href="index.html"; }
document.getElementById("welcomeMsg").textContent=`Welcome ${currentUser.name} to Admin Page`;

let cachedRequests=[], currentFilter="All", currentView="list", calendarMonth=new Date().getMonth(), calendarYear=new Date().getFullYear(), calendarMode="month";

function loadRequests(){
  db.collection("single_day_leave").onSnapshot(snap=>{
    cachedRequests=[];
    snap.forEach(d=>cachedRequests.push({id:d.id,...d.data()}));
    render();
  });
}

function setFilter(f){ currentFilter=f; render(); }
function setView(v){ currentView=v; toggleCalendarControls(); render(); }
function setCalendarMode(mode){ calendarMode=mode; render(); }

function toggleCalendarControls(){
  document.getElementById("calendarControls").style.display=(currentView==='calendar')?'flex':'none';
  document.getElementById("calendarContainer").style.display=(currentView==='calendar')?'block':'none';
  document.getElementById("table").style.display=(currentView!=='calendar')?'table':'none';

  // Show month selector only for Table view
  document.getElementById("monthSelect").style.display=(currentView==='table')?'inline-block':'none';
}

function logout(){ if(confirm("Are you sure?")){ localStorage.removeItem("currentUser"); location.href="index.html"; } }

function render(){
  const data = currentFilter==="All"?cachedRequests:cachedRequests.filter(r=>r.status===currentFilter);
  if(currentView==='list') renderList(data);
  else if(currentView==='table') renderTableView(data);
  else if(currentView==='calendar') calendarMode==='month'?renderCalendar(data):renderYearView(data);
}

function renderList(data){
  const t=document.getElementById("table");
  t.style.display="table";
  t.innerHTML=`<tr><th>Employee</th><th>Leave Type</th><th>Date</th><th>Submitted At</th><th>Reason</th><th>Status</th><th>Action</th></tr>`;
  data.forEach(l=>{
    let s=l.submittedAt && l.submittedAt.toDate?l.submittedAt.toDate():new Date(l.submittedAt);
    let str=s.toLocaleString("en-PH",{timeZone:"Asia/Manila",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});
    t.innerHTML+=`<tr><td>${l.employeeName}</td><td>${l.type}</td><td>${l.date}</td><td>${str}</td><td>${l.reason}</td><td class="status-${l.status}">${l.status}</td>
    <td>
      <button class="approve" onclick="updateStatus('${l.id}','Approved')">Approve</button>
      <button class="pend" onclick="updateStatus('${l.id}','Pending')">Pend</button>
      <button class="reject" onclick="updateStatus('${l.id}','Rejected')">Reject</button>
    </td></tr>`;
  });
}

// Table view
function renderTableView(data){
  const t=document.getElementById("table");
  t.style.display="table";

  const month = parseInt(document.getElementById("monthSelect").value); // Use selected month
  const y = new Date().getFullYear();

  const tlnames=[...new Set(data.map(l=>l.tlName || l.employeeName))];
  const daysInMonth=new Date(y,month+1,0).getDate();
  let html=`<tr><th>TL Name</th>`;
  for(let d=1;d<=daysInMonth;d++) html+=`<th>${d}</th>`;
  html+="</tr>";

  tlnames.forEach(tl=>{
    html+=`<tr><td>${tl}</td>`;
    for(let d=1;d<=daysInMonth;d++){
      const cellDate=new Date(y,month,d);
      let letter="", colorClass="";
      data.forEach(l=>{
        if((l.tlName||l.employeeName)===tl){
          const ld=new Date(l.date);
          if(ld.getFullYear()===cellDate.getFullYear() && ld.getMonth()===cellDate.getMonth() && ld.getDate()===cellDate.getDate()){
            letter=l.status==="Approved"?"A":l.status==="Rejected"?"R":"P";
            colorClass=letter;
          }
        }
      });
      html+=letter?`<td><span class="table-indicator ${colorClass}" title="${tl} ${letter}">${letter}</span></td>`:"<td></td>";
    }
    html+="</tr>";
  });
  t.innerHTML=html;
}

// Month Calendar
function renderCalendar(data){
  const grid=document.getElementById("calendarGrid");
  grid.innerHTML=""; grid.style.gridTemplateColumns="repeat(7,1fr)"; grid.className="calendar";
  const y=calendarYear, m=calendarMonth;
  const days=new Date(y,m+1,0).getDate();
  const start=new Date(y,m,1).getDay();
  ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d=>{ const h=document.createElement("div"); h.className="cal-header"; h.textContent=d; grid.appendChild(h); });
  for(let i=0;i<start;i++){ const e=document.createElement("div"); e.className="cal-cell"; grid.appendChild(e); }
  for(let d=1;d<=days;d++){
    const cell=document.createElement("div"); cell.className="cal-cell";
    const dayDiv=document.createElement("div"); dayDiv.className="cal-day"; dayDiv.textContent=d; cell.appendChild(dayDiv);
    const cd=new Date(y,m,d);
    data.forEach(l=>{
      const ld=new Date(l.date);
      if(ld.getFullYear()===cd.getFullYear() && ld.getMonth()===cd.getMonth() && ld.getDate()===cd.getDate()){
        const c=l.status==="Approved"?"A":l.status==="Rejected"?"R":"P";
        const span=document.createElement("span"); span.className="indicator "+c; span.textContent=l.tlName||l.employeeName; span.title=`${l.employeeName}: ${l.date} - ${l.status}`;
        cell.appendChild(span);
      }
    });
    grid.appendChild(cell);
  }
  document.getElementById("calendarMonthLabel").textContent=`${new Date(y,m).toLocaleString('default',{month:'long'})} ${y}`;
}

// Year View
function renderYearView(data){
  const grid=document.getElementById("calendarGrid");
  grid.innerHTML=""; grid.style.gridTemplateColumns="repeat(3,1fr)"; grid.className="year-view";
  const y=new Date().getFullYear();
  for(let m=0;m<12;m++){
    const monthDiv=document.createElement("div"); monthDiv.className="year-month";
    const label=document.createElement("div"); label.className="year-month-label"; label.textContent=new Date(y,m).toLocaleString('default',{month:'short'}); monthDiv.appendChild(label);
    const miniGrid=document.createElement("div"); miniGrid.className="mini-grid";
    const start=new Date(y,m,1).getDay();
    for(let i=0;i<start;i++){ const empty=document.createElement("div"); empty.className="day-cell"; miniGrid.appendChild(empty);}
    const days=new Date(y,m+1,0).getDate();
    for(let d=1;d<=days;d++){
      const cell=document.createElement("div"); cell.className="day-cell"; cell.textContent=d;
      const cd=new Date(y,m,d);
      const leaves=data.filter(l=>{ const ld=new Date(l.date); return ld.getFullYear()===cd.getFullYear() && ld.getMonth()===cd.getMonth() && ld.getDate()===cd.getDate(); });
      if(leaves.length>0){
        const dotC=document.createElement("div"); dotC.className="day-dots";
        leaves.forEach(l=>{ const dot=document.createElement("div"); dot.className="dot "+(l.status==="Approved"?"approved":l.status==="Rejected"?"rejected":"pending"); dot.title=`${l.employeeName} (${l.status})`; dotC.appendChild(dot); });
        cell.appendChild(dotC);
      }
      miniGrid.appendChild(cell);
    }
    monthDiv.appendChild(miniGrid);
    monthDiv.onclick=()=>{ calendarMonth=m; setCalendarMode('month'); };
    grid.appendChild(monthDiv);
  }
}

async function updateStatus(id,status){ await db.collection("single_day_leave").doc(id).update({status}); }

function changeCalendarMonth(diff){ calendarMonth+=diff; if(calendarMonth<0){calendarMonth=11; calendarYear--;} if(calendarMonth>11){calendarMonth=0; calendarYear++;} render(); }

toggleCalendarControls(); render(); loadRequests();
</script>
</body>
</html>
