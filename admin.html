<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FedEx Leave System - Admin</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --fedex-purple: #4D148C;
  --fedex-orange: #FF6600;
  --bg-gray: #f4f4f6;
}

body { 
  margin:0; font-family:Arial,sans-serif; background:var(--bg-gray); display:flex; flex-direction:column; min-height:100vh; 
}
header,footer { 
  background:var(--fedex-purple); color:white; padding:15px 20px; font-size:1.2em; font-weight:bold; display:flex; justify-content:space-between; align-items:center; 
}
header button { 
  background:var(--fedex-orange); color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:bold; 
}
main { flex:1; padding:20px; }
h2 { color:var(--fedex-purple); text-align:center; }
.card { background:white; padding:25px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.1); overflow-x:auto; }

button.approve { background:green;color:white;padding:5px 8px;border-radius:4px;border:none;margin:2px;cursor:pointer; }
button.pend { background:orange;color:white;padding:5px 8px;border-radius:4px;border:none;margin:2px; cursor:pointer; }
button.reject { background:red;color:white;padding:5px 8px;border-radius:4px;border:none;margin:2px; }
button.cancel{background:#555;color:white;padding:5px 8px;border-radius:4px;border:none;margin:2px;cursor:pointer}

.status-Pending{ color:orange; font-weight:bold; }
.status-Approved{ color:green; font-weight:bold; }
.status-Rejected{ color:red; font-weight:bold; }
.status-Cancelled{color:#555;font-weight:bold}

/* Table */
#table { width:100%; border-collapse:collapse; margin-top:10px; }
#table th,#table td { border:1px solid #ddd; padding:8px; text-align:left; }
#table th { background:var(--fedex-purple); color:white; }
#table tr:nth-child(even){ background:#f9f9f9; }

/* Calendar */
.calendar-wrapper { display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:10px; }
.calendar { display:grid; grid-template-columns: repeat(7,1fr); gap:2px; }
.cal-header { font-weight:bold; background:var(--fedex-purple); color:white; padding:6px 0; border-radius:4px; }
.cal-cell { background:white; border:1px solid #ddd; min-height:80px; display:flex; flex-direction:column; align-items:flex-start; padding:4px; position:relative; border-radius:4px; font-size:12px; overflow:hidden; }
.cal-cell:hover { background:#f0f0f0; cursor:pointer; }
.cal-day { font-weight:bold; margin-bottom:2px; }
.indicator { display:block; padding:1px 3px; margin:1px 0; border-radius:3px; color:white; font-size:10px; font-weight:bold; overflow:hidden; text-overflow:ellipsis; }

/* Table indicator */
.table-indicator { display:inline-block; width:22px; height:22px; border-radius:50%; color:white; font-weight:bold; text-align:center; line-height:22px; margin:2px; font-size:12px; }
.A{background:green;} .P{background:orange;} .R{background:red;}

/* Year view mini calendars */
.year-view { display:grid; grid-template-columns:repeat(3,1fr); gap:15px; }
.year-month { border:1px solid #ccc; border-radius:8px; padding:5px; background:#fff; cursor:pointer; display:flex; flex-direction:column; transition:transform 0.2s; }
.year-month:hover{transform:scale(1.02); box-shadow:0 4px 8px rgba(0,0,0,0.2);}
.year-month-label{ text-align:center; font-weight:bold; margin-bottom:4px; }
.mini-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; font-size:8px; }
.mini-grid .day-cell { height:20px; width:20px; border-radius:4px; text-align:center; line-height:20px; position:relative; border:1px solid #eee; font-size:8px; }
.mini-grid .day-dots { position:absolute; bottom:1px; left:50%; transform:translateX(-50%); display:flex; gap:1px; }
.dot { width:4px; height:4px; border-radius:50%; }
.dot.approved{background:green;} .dot.pending{background:orange;} .dot.rejected{background:red;}

/* Modal */
.modal{
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:999;
}
.modal-content{
  background:#fff;padding:20px;border-radius:10px;width:320px;text-align:center;
}
.modal-content h3{margin-top:0;color:#333}
.modal-actions button{margin:8px;padding:6px 14px;border-radius:5px;border:none;cursor:pointer}
.modal-confirm{background:red;color:white}
.modal-cancel{background:#ccc}

/* Top Controls - Modern Professional Style */
.top-controls {
  display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between;
  background:#fff; padding:12px 20px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.08);
  margin-bottom:20px;
}

/* View Selector */
.view-select-wrapper { display:flex; align-items:center; gap:8px; margin-right:20px; }
.view-select-wrapper label { font-weight:bold; color:var(--fedex-purple); }
.view-select-wrapper select { padding:6px 10px; border-radius:6px; border:1px solid #ccc; cursor:pointer; font-weight:500; min-width:120px; }

/* Filters + Export - inline */
#listControls { display:flex; flex-wrap:wrap; align-items:center; gap:12px; flex:1; }
.filter-item { display:flex; flex-direction:column; font-size:0.85em; }
.filter-item label { font-weight:bold; color:#333; margin-bottom:4px; }
.filter-item select, .filter-item input { padding:6px 10px; border-radius:6px; border:1px solid #ccc; cursor:pointer; min-width:120px; }

#exportBtn { background:var(--fedex-purple); color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-size:1.2em; display:flex; align-items:center; justify-content:center; transition:background 0.2s; }
#exportBtn:hover { background:var(--fedex-orange); }

#monthSelectWrapper {
  display: flex;
  justify-content: center; /* center horizontally */
  margin: 15px 0;
}

#monthSelect {
  padding: 8px 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: #fff;
  font-size: 1em;
  font-weight: 500;
  color: #333;
  cursor: pointer;
  min-width: 150px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transition: all 0.2s ease;
}

#monthSelect:hover {
  border-color: var(--fedex-purple);
  box-shadow: 0 6px 16px rgba(0,0,0,0.12);
}

#monthSelect:focus {
  outline: none;
  border-color: var(--fedex-orange);
  box-shadow: 0 0 0 3px rgba(255,102,0,0.2);
}

</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
<header>
  <span id="welcomeMsg">Welcome to Admin Page</span>
  <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
</header>

<main>
  <!-- Top Controls -->
  <div class="top-controls">
    <!-- View Selector -->
    <div class="view-select-wrapper">
      <label for="viewSelect">View:</label>
      <select id="viewSelect" onchange="setView(this.value)">
        <option value="list">List View</option>
        <option value="table">Table View</option>
        <option value="calendar">Calendar View</option>
      </select>
    </div>

    <!-- Filters + Export (Only List View) -->
    <div id="listControls">
      <div class="filter-item">
        <label for="filterStatus">Status</label>
        <select id="filterStatus" onchange="applyFilters()">
          <option value="All">All Status</option>
          <option value="Approved">Approved</option>
          <option value="Pending">Pending</option>
          <option value="Rejected">Rejected</option>
          <option value="Cancelled">Cancelled</option>
        </select>
      </div>
      <div class="filter-item">
        <label for="filterType">Leave Type</label>
        <select id="filterType" onchange="applyFilters()">
          <option value="All">All Types</option>
          <option value="Vacation">Vacation</option>
          <option value="Sick">Sick</option>
          <option value="Others">Others</option>
        </select>
      </div>
      <div class="filter-item">
        <label for="filterDate">Leave Date</label>
        <input type="date" id="filterDate" onchange="applyFilters()">
      </div>
      <div class="filter-item">
        <label for="filterSubmitted">Submitted Date</label>
        <input type="date" id="filterSubmitted" onchange="applyFilters()">
      </div>
      <button id="exportBtn" title="Export" onclick="exportCSV()">
        <i class="fas fa-file-export"></i>
      </button>
    </div>
  </div>

<!-- Month selector for Table view -->
<div id="monthSelectWrapper" style="display:none;">
  <select id="monthSelect" onchange="render()">
    <option value="0">January</option>
    <option value="1">February</option>
    <option value="2">March</option>
    <option value="3">April</option>
    <option value="4">May</option>
    <option value="5">June</option>
    <option value="6">July</option>
    <option value="7">August</option>
    <option value="8">September</option>
    <option value="9">October</option>
    <option value="10">November</option>
    <option value="11">December</option>
  </select>
</div>

  <div class="calendar-wrapper" id="calendarControls">
    <button onclick="changeCalendarMonth(-1)">◀</button>
    <span id="calendarMonthLabel"></span>
    <button onclick="changeCalendarMonth(1)">▶</button>
    <button onclick="setCalendarMode('month')">Month</button>
    <button onclick="setCalendarMode('year')">Year</button>
  </div>

  <div class="card">
   
    <div id="calendarContainer"><div class="calendar" id="calendarGrid"></div></div>
    <table id="table"></table>
  </div>

</main>
<footer>© FedEx 2026</footer>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyAFedbBDXSZomKX8MQkBfVBRfi6tl0LTcc",
  authDomain:"fedex-attendance-system.firebaseapp.com",
  projectId:"fedex-attendance-system"
});
const db=firebase.firestore();

const currentUser=JSON.parse(localStorage.getItem("currentUser"));
if(!currentUser){ alert("Please login first"); location.href="index.html"; }
document.getElementById("welcomeMsg").textContent=`Welcome ${currentUser.name} to Admin Page`;

let cachedRequests=[], currentFilter="All", currentView="list", calendarMonth=new Date().getMonth(), calendarYear=new Date().getFullYear(), calendarMode="month";

function loadRequests(){
  db.collection("single_day_leave").onSnapshot(snap=>{
    cachedRequests=[];
    snap.forEach(d=>cachedRequests.push({id:d.id,...d.data()}));
    render();
  });
}

function setView(v){
  currentView = v;

  // Show/hide list controls
  document.getElementById("listControls").style.display = (v==='list')?'flex':'none';

  toggleCalendarControls();

  // Reset filters for non-list views
  if(v!=='list'){
    document.getElementById("filterStatus").value = "All";
    document.getElementById("filterType").value = "All";
    document.getElementById("filterDate").value = "";
    document.getElementById("filterSubmitted").value = "";
    document.getElementById("monthSelectWrapper").style.display = (currentView==='table')?'flex':'none';
  }

  render();
}

function toggleCalendarControls(){
  document.getElementById("calendarControls").style.display=(currentView==='calendar')?'flex':'none';
  document.getElementById("calendarContainer").style.display=(currentView==='calendar')?'block':'none';
  document.getElementById("table").style.display=(currentView!=='calendar')?'table':'none';
  document.getElementById("monthSelect").style.display=(currentView==='table')?'inline-block':'none';
}

function logout(){ if(confirm("Are you sure?")){ localStorage.removeItem("currentUser"); location.href="index.html"; } }

function render(){
  const data = currentFilter==="All"?cachedRequests:cachedRequests.filter(r=>r.status===currentFilter);
  if(currentView==='list') applyFilters(); // List view uses filters
  else if(currentView==='table') renderTableView(data);
  else if(currentView==='calendar') calendarMode==='month'?renderCalendar(data):renderYearView(data);
}

function applyFilters() {
  const status = document.getElementById("filterStatus").value;
  const type = document.getElementById("filterType").value;
  const date = document.getElementById("filterDate").value;
  const submitted = document.getElementById("filterSubmitted").value;

  let data = cachedRequests;

  if(status !== "All") data = data.filter(r => r.status === status);

  if(type !== "All") {
    if(type === "Others") {
      // Match anything that is not Vacation or Sick
      data = data.filter(r => r.type !== "Vacation" && r.type !== "Sick");
    } else {
      data = data.filter(r => r.type === type);
    }
  }

  if(date) data = data.filter(r => r.date === date);

  if(submitted) data = data.filter(r => {
    let subDate = r.submittedAt && r.submittedAt.toDate ? r.submittedAt.toDate() : new Date(r.submittedAt);
    return subDate.toISOString().split("T")[0] === submitted;
  });

  renderList(data);
}

function renderList(data){
  const t=document.getElementById("table");
  t.style.display="table";
  t.innerHTML=`<tr><th>Employee</th><th>Leave Type</th><th>Date</th><th>Submitted At</th><th>Reason</th><th>Status</th><th>Action</th></tr>`;
  data.forEach(l=>{
    let s=l.submittedAt && l.submittedAt.toDate?l.submittedAt.toDate():new Date(l.submittedAt);
    let str=s.toLocaleString("en-PH",{timeZone:"Asia/Manila",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});
    t.innerHTML+=`<tr>
      <td>${l.employeeName}</td>
      <td>${l.type}</td>
      <td>${l.date}</td>
      <td>${str}</td>
      <td>${l.reason}</td>
      <td class="status-${l.status}">${l.status}</td>
      <td>
        <button class="approve" onclick="updateStatus('${l.id}','Approved')">Approve</button>
        <button class="pend" onclick="updateStatus('${l.id}','Pending')">Pend</button>
        <button class="reject" onclick="updateStatus('${l.id}','Rejected')">Reject</button>
        <button class="cancel" onclick="openCancelModal('${l.id}')">Cancel</button>
      </td>
    </tr>`;
  });
}

function exportCSV(){
  const data = cachedRequests; // export all cached
  let csv="Employee,Type,Date,Submitted At,Reason,Status\n";
  data.forEach(l=>{
    let s=l.submittedAt && l.submittedAt.toDate?l.submittedAt.toDate():new Date(l.submittedAt);
    csv+=`${l.employeeName},${l.type},${l.date},${s.toLocaleString()},${l.reason},${l.status}\n`;
  });
  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download="leave_requests.csv"; a.click();
  URL.revokeObjectURL(url);
}

// Table view
function renderTableView(data){
  const t=document.getElementById("table");
  t.style.display="table";

  const month = parseInt(document.getElementById("monthSelect").value); // Use selected month
  const y = new Date().getFullYear();

  const tlnames=[...new Set(data.map(l=>l.tlName || l.employeeName))];
  const daysInMonth=new Date(y,month+1,0).getDate();
  let html=`<tr><th>TL Name</th>`;
  for(let d=1;d<=daysInMonth;d++) html+=`<th>${d}</th>`;
  html+="</tr>";

  tlnames.forEach(tl=>{
    html+=`<tr><td>${tl}</td>`;
    for(let d=1;d<=daysInMonth;d++){
      const cellDate=new Date(y,month,d);
      let letter="", colorClass="";
      data.forEach(l=>{
        if((l.tlName||l.employeeName)===tl){
          const ld=new Date(l.date);
          if(ld.getFullYear()===cellDate.getFullYear() && ld.getMonth()===cellDate.getMonth() && ld.getDate()===cellDate.getDate()){
            letter=l.status==="Approved"?"A":l.status==="Rejected"?"R":"P";
            colorClass=letter;
          }
        }
      });
      html+=letter?`<td><span class="table-indicator ${colorClass}" title="${tl} ${letter}">${letter}</span></td>`:"<td></td>";
    }
    html+="</tr>";
  });
  t.innerHTML=html;
}

// Month Calendar
function renderCalendar(data){
  const grid=document.getElementById("calendarGrid");
  grid.innerHTML=""; grid.style.gridTemplateColumns="repeat(7,1fr)"; grid.className="calendar";
  const y=calendarYear, m=calendarMonth;
  const days=new Date(y,m+1,0).getDate();
  const start=new Date(y,m,1).getDay();
  ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d=>{ const h=document.createElement("div"); h.className="cal-header"; h.textContent=d; grid.appendChild(h); });
  for(let i=0;i<start;i++){ const e=document.createElement("div"); e.className="cal-cell"; grid.appendChild(e); }
  for(let d=1;d<=days;d++){
    const cell=document.createElement("div"); cell.className="cal-cell";
    const dayDiv=document.createElement("div"); dayDiv.className="cal-day"; dayDiv.textContent=d; cell.appendChild(dayDiv);
    const cd=new Date(y,m,d);
    data.forEach(l=>{
      const ld=new Date(l.date);
      if(ld.getFullYear()===cd.getFullYear() && ld.getMonth()===cd.getMonth() && ld.getDate()===cd.getDate()){
        const c=l.status==="Approved"?"A":l.status==="Rejected"?"R":"P";
        const span=document.createElement("span"); span.className="indicator "+c; span.textContent=l.tlName||l.employeeName; span.title=`${l.employeeName}: ${l.date} - ${l.status}`;
        cell.appendChild(span);
      }
    });
    grid.appendChild(cell);
  }
  document.getElementById("calendarMonthLabel").textContent=`${new Date(y,m).toLocaleString('default',{month:'long'})} ${y}`;
}

// Year View
function renderYearView(data){
  const grid=document.getElementById("calendarGrid");
  grid.innerHTML=""; grid.style.gridTemplateColumns="repeat(3,1fr)"; grid.className="year-view";
  const y=new Date().getFullYear();
  for(let m=0;m<12;m++){
    const monthDiv=document.createElement("div"); monthDiv.className="year-month";
    const label=document.createElement("div"); label.className="year-month-label"; label.textContent=new Date(y,m).toLocaleString('default',{month:'short'}); monthDiv.appendChild(label);
    const miniGrid=document.createElement("div"); miniGrid.className="mini-grid";
    const start=new Date(y,m,1).getDay();
    for(let i=0;i<start;i++){ const empty=document.createElement("div"); empty.className="day-cell"; miniGrid.appendChild(empty);}
    const days=new Date(y,m+1,0).getDate();
    for(let d=1;d<=days;d++){
      const cell=document.createElement("div"); cell.className="day-cell"; cell.textContent=d;
      const cd=new Date(y,m,d);
      const leaves=data.filter(l=>{ const ld=new Date(l.date); return ld.getFullYear()===cd.getFullYear() && ld.getMonth()===cd.getMonth() && ld.getDate()===cd.getDate(); });
      if(leaves.length>0){
        const dotC=document.createElement("div"); dotC.className="day-dots";
        leaves.forEach(l=>{ const dot=document.createElement("div"); dot.className="dot "+(l.status==="Approved"?"approved":l.status==="Rejected"?"rejected":"pending"); dot.title=`${l.employeeName} (${l.status})`; dotC.appendChild(dot); });
        cell.appendChild(dotC);
      }
      miniGrid.appendChild(cell);
    }
    monthDiv.appendChild(miniGrid);
    monthDiv.onclick=()=>{ calendarMonth=m; setCalendarMode('month'); };
    grid.appendChild(monthDiv);
  }
}

let cancelTargetId = null;
function openCancelModal(id){ cancelTargetId = id; document.getElementById("cancelModal").style.display = "flex"; }
function closeCancelModal(){ cancelTargetId = null; document.getElementById("cancelModal").style.display = "none"; }
function confirmCancel(){ if(cancelTargetId){ db.collection("single_day_leave").doc(cancelTargetId).update({status:"Cancelled"}); closeCancelModal(); } }

async function updateStatus(id,status){ await db.collection("single_day_leave").doc(id).update({status}); }

function changeCalendarMonth(diff){ calendarMonth+=diff; if(calendarMonth<0){calendarMonth=11; calendarYear--;} if(calendarMonth>11){calendarMonth=0; calendarYear++;} render(); }


toggleCalendarControls(); render(); loadRequests();
</script>

<div class="modal" id="cancelModal">
  <div class="modal-content">
    <h3>Cancel Leave Request?</h3>
    <p>Are you sure you want to cancel this leave?</p>
    <div class="modal-actions">
      <button class="modal-confirm" onclick="confirmCancel()">Yes, Cancel</button>
      <button class="modal-cancel" onclick="closeCancelModal()">No</button>
    </div>
  </div>
</div>
</body>
</html>
